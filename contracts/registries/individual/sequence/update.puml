@startuml
title Individual - Update
!theme vibrant
participant Client as c
participant IndividualRegistry as s
participant RedisCache as rc
queue Kafka as k
participant PersisterService as prs
participant IndexerService as idx
participant ErrorService as es
participant ElasticSearch as el
database Database as db
c -> s : /individual/v1/_update
activate s
s -> s: Validate request body
alt request validation fails
    s -> s: Request validation failed
    s -> k: Individual Data /error_topic
    note left
        This will be marked as unrecoverable right away 
        and require manual intervention
    end note
    activate k
    group async
        es -> k: Consume Individual Data
        activate es
        deactivate k
        es -> db: Persist Individual Data /error_table
        activate db
        deactivate db
        deactivate es
    end
    s -> c: HttpStatus: 400 with appropriate error code
    note left
      Error Code: REQUEST_VALIDATION_FAILED
    end note
end
s -> s: Request validation successful
alt record doesn't exist
    s -> rc: Search record based on clientReferenceId/serverGeneratedId
    activate rc
    rc -> s: 0 rows
    deactivate rc
    s -> db: Search record based on clientReferenceId/serverGeneratedId
    activate db
    db -> s: 0 row
    deactivate db
    s -> k: Individual Data /error_topic
    group async
        es -> k: Consume Individual Data
        activate es
        deactivate k
        es -> db: Persist Individual Data /error_table
        activate db
        deactivate db
        deactivate es
    end
    s -> c: HttpStatus: 400 with appropriate error code
    note left
      Error Code: RECORD_NOT_FOUND
    end note
end
alt record doesn't exists in cache
    s -> rc: Search record based on clientReferenceId/serverGeneratedId
    activate rc
    rc -> s: 0 rows
    deactivate rc
    s -> db: Search record based on clientReferenceId/serverGeneratedId
    activate db
    db -> s: 1 row
    deactivate db
    s -> rc: 1 record
    activate rc
    deactivate rc
end
s -> rc: Fetch the existing record
activate rc
rc -> s: 1 row
deactivate rc
'ir -> ir: Check if the new record is not equal to existing record
'alt new record equals existing record
'    ir -> ir: New record equals existing record
'    ir -> c: HttpStatus: 202 ACCEPTED with appropriate response code
'end
s -> k: Individual Data /update_topic
activate k
s -> rc: Update new record in cache against clientReferenceId/serverGeneratedId
activate rc
deactivate rc
s -> c: HttpStatus: 202 ACCEPTED
deactivate s
group async
    prs -> k: Consume Individual Data
    activate prs
    idx -> k: Consume Individual Data
    activate idx
    idx -> el: Store Individual Data
    activate el
    deactivate el
    deactivate idx
    prs -> db: Update Individual Data
    activate db
    deactivate db
    deactivate prs
end
deactivate k
@enduml